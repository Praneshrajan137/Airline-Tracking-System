# ============================================
# WORKFLOW VALIDATION - Quick Health Check
# ============================================
# This minimal workflow validates that GitHub Actions can run successfully
# It should complete in < 30 seconds
#
# Purpose:
#   - Verify GitHub Actions environment is properly configured
#   - Test basic checkout and setup steps
#   - Confirm repository structure is accessible
#
# Trigger: Manual only (workflow_dispatch)

name: Validate CI/CD Setup

on:
  workflow_dispatch: # Manual trigger only

permissions:
  contents: read

jobs:
  validate:
    name: Validate Workflow Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: âœ… Validate Repository Structure
        run: |
          echo "ðŸ” Validating repository structure..."
          
          # Check for .github/workflows directory
          if [ -d ".github/workflows" ]; then
            echo "âœ… .github/workflows directory exists"
          else
            echo "âŒ FAILED: .github/workflows directory not found"
            exit 1
          fi
          
          # Check for CI/CD workflow file
          if [ -f ".github/workflows/ci-cd.yml" ]; then
            echo "âœ… ci-cd.yml workflow file exists"
          else
            echo "âŒ FAILED: ci-cd.yml not found"
            exit 1
          fi
          
          # Check for services directory
          if [ -d "services" ]; then
            echo "âœ… services directory exists"
          else
            echo "âŒ FAILED: services directory not found"
            exit 1
          fi
          
          # Check for all microservices
          echo ""
          echo "ðŸ” Checking microservices..."
          for service in service-registry api-gateway flightdata-service llm-summary-service; do
            if [ -d "services/$service" ]; then
              echo "âœ… services/$service directory exists"
              
              # Check for pom.xml
              if [ -f "services/$service/pom.xml" ]; then
                echo "  âœ… pom.xml found"
              else
                echo "  âŒ FAILED: pom.xml not found in $service"
                exit 1
              fi
              
              # Check for Dockerfile
              if [ -f "services/$service/Dockerfile" ]; then
                echo "  âœ… Dockerfile found"
              else
                echo "  âš ï¸  WARNING: Dockerfile not found in $service"
              fi
            else
              echo "âŒ FAILED: services/$service directory not found"
              exit 1
            fi
          done
          
          echo ""
          echo "âœ… All validation checks passed!"
          echo "ðŸŽ‰ Repository structure is valid for CI/CD pipeline"

      - name: â˜• Test Java Setup
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: âœ… Verify Java Installation
        run: |
          echo "ðŸ” Verifying Java installation..."
          java -version
          echo ""
          echo "âœ… Java 17 is properly installed"

      - name: ðŸ“‹ Validation Summary
        run: |
          echo "## âœ… Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed! Your CI/CD pipeline is ready to run." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Push changes to \`main\` or \`develop\` branch" >> $GITHUB_STEP_SUMMARY
          echo "2. The main CI/CD pipeline will automatically trigger" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor the pipeline run in the Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Expected Pipeline Duration:" >> $GITHUB_STEP_SUMMARY
          echo "- Build & Test: ~10-15 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ~5-10 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Build: ~15-20 minutes (only on main branch)" >> $GITHUB_STEP_SUMMARY
          echo "- Total: ~15-45 minutes depending on branch and caching" >> $GITHUB_STEP_SUMMARY
